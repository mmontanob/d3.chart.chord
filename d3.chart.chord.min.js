d3.chart("ChordMatrix",{initialize:function(){function t(){return this.style("fill",e.edgColor).style("opacity",function(t){return"number"==typeof e.focus&&t.source.index!=e.focus&&t.source.subindex!=e.focus?"0.1":"0.75"}).filter(e.filterPaths).attr("d",function(t){return e.createChord(t,s)}).append("title").text(function(t){var r=t.source.value+" "+e.grps[t.source.index]+" as "+e.grps[t.source.subindex];return t.source.index!=t.target.index&&(r+=", "+t.target.value+" "+e.grps[t.target.index]+" as "+e.grps[t.target.subindex]),r})}var e=this;e.base.classed("ChordMatrix",!0),e.w=e.base.attr("width"),e.h=e.base.attr("height"),e.focus=null,e.mtx=e.mtx?e.mtx:[];var r=e.base.append("g").classed("chart",!0),s=d3.svg.chord();e.total=100,e.grps=e.grps?e.grps:[],e.centers=[],e.selfTotals=[],e.edgColor="gray",e.hasLabels=!1;var n=e.layer("chart",r,{dataBind:function(t){function n(t){e.focus=t.index,e.draw(e.scale)}function a(){e.focus=null,e.draw(e.scale)}e.scale=t,r.attr("transform","translate("+e.w/2+","+e.h/2+")"),e.radius();var i=d3.layout.chord().sortGroups(d3.descending).sortSubgroups(d3.descending).sortChords(d3.descending).padding(.04),u=10*(e.grps.length-1),o=e.hasLabels?10:0,h=d3.svg.arc().innerRadius(e.innerRadius-u-o).outerRadius(e.outerRadius-o);s.radius(e.innerRadius-u-o),i.matrix(e.mtx);var d=this.selectAll(".group").data(i.groups).enter().append("g").attr("class","group");return d.append("path").style("fill","#e6e9f0").attr("id",function(t){return"group"+t.index}).attr("d",function(t){return e.centers[t.index]=[t.startAngle,t.endAngle],h(t)}).on("mouseover",n).on("mouseout",a).append("title").text(function(t){return e.grps[t.index]}),e.grps.forEach((t,r)=>{var s=10*(r+(e.hasLabels?1:0)),i=d3.svg.arc().innerRadius(e.innerRadius-s).outerRadius(e.outerRadius-s);d.append("path").style("fill",function(t){return e.scale(r)}).style("stroke",function(t){return d3.rgb(e.scale(r)).darker()}).attr("id",function(t){return"group-bar"+t.index+"-"+r}).attr("d",function(t){var s=t.endAngle-t.startAngle,n=e.percs[t.index][r];return i.endAngle(t.startAngle+s*n),i(t)}).on("mouseover",n).on("mouseout",a).append("title").text(function(t){return e.grps[r]+" = "+(r==t.index?e.selfTotals[r]:e.mtx[t.index][r])})}),e.hasLabels&&d.append("text").attr("font-family","sans-serif").attr("x",function(t){var r=(t.endAngle-t.startAngle)/(2*Math.PI);return Math.PI*e.innerRadius*r}).attr("dy",-2).filter(function(t){return.1<=t.value/e.total}).append("textPath").attr("xlink:href",function(t){return"#group"+t.index}).text(function(t){return e.grps[t.index]}),this.selectAll(".chord").data(i.chords)},insert:function(){return this.append("path").attr("class","chord")}});n.on("enter",t),n.on("update",t)},edgesColor:function(t){return arguments.length?(this.edgColor=t,this.scale&&this.draw(this.scale),this):this.edgColor},createChord:function(t,e){return e(t)},filterPaths:function(t){return!0},radius:function(){this.outerRadius=Math.min(this.w,this.h)/2-4,this.innerRadius=this.outerRadius-10},groups:function(t){return arguments.length?(this.grps=t,this.scale&&this.draw(this.scale),this):this.groups},width:function(t){return arguments.length?(this.w=t,this.x=d3.scale.linear().range([0,this.w]),this.base.attr("width",this.w),this.scale&&this.draw(this.scale),this):this.w},height:function(t){return arguments.length?(this.h=t,this.base.attr("height",this.h),this.scale&&this.draw(this.scale),this):this.h},calcMaxError:function(){this.maxError=0,this.selfTotals=this.mtx.map((t,e)=>t[e])},matrix:function(t){if(!arguments.length)return this.mtx;this.mtx=t.map(t=>t.slice());var e=this.mtx.map(t=>t.reduce((t,e)=>t+e));return this.percs=this.mtx.map((t,r)=>t.map(t=>t/e[r])),this.total=e.reduce((t,e)=>t+e),this.calcMaxError(),this.scale&&this.draw(this.scale),this},labels:function(t){return arguments.length?(this.hasLabels=t,this.scale&&this.draw(this.scale),this):this.hasLabels}}),d3.chart("ChordMatrix").extend("ChordConfusionMatrix",{calcMaxError:function(){this.selfTotals=[],this.mtx=this.mtx.map((t,e)=>(this.selfTotals[e]=t[e],t[e]=0,t));var t=(t,e)=>t+e;this.maxError=this.mtx.map((e,r)=>e.reduce(t)).reduce((t,e)=>Math.max(t,e)),this.total=this.mtx.map(e=>e.reduce(t)).reduce(t)},createChord:function(t,e){var r=this.centers[t.source.index],s=r[1]-r[0],n=Math.min(.25,s),a=r[0]+s/2-n/2;t.source.startAngle=a,t.source.endAngle=a+n*(t.source.value/this.maxError);var i=this.centers[t.target.index],u=i[1]-i[0],o=Math.min(.25,u),h=i[0]+u/2-o/2;return t.target.startAngle=h,t.target.endAngle=h+o*(t.target.value/this.maxError),e(t)},filterPaths:function(t){return t.source.index!=t.source.subindex}});